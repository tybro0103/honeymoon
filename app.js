
// const images = [
//   {key: '1',  pathLarge: '1.JPG',  pathSmall: '1 Small.png'},
//   {key: '2',  pathLarge: '2.JPG',  pathSmall: '2 Small.png'},
//   {key: '3',  pathLarge: '3.JPG',  pathSmall: '3 Small.png'},
//   {key: '4',  pathLarge: '4.JPG',  pathSmall: '4 Small.png'},
//   {key: '5',  pathLarge: '5.JPG',  pathSmall: '5 Small.png'},
//   {key: '6',  pathLarge: '6.JPG',  pathSmall: '6 Small.png'},
//   {key: '7',  pathLarge: '7.JPG',  pathSmall: '7 Small.png'},
//   {key: '8',  pathLarge: '8.JPG',  pathSmall: '8 Small.png'},
//   {key: '9',  pathLarge: '9.JPG',  pathSmall: '9 Small.png'},
//   {key: '10', pathLarge: '10.JPG', pathSmall: '10 Small.png'},
//   {key: '11', pathLarge: '11.JPG', pathSmall: '11 Small.png'},
//   {key: '12', pathLarge: '12.JPG', pathSmall: '12 Small.png'},
//   {key: '13', pathLarge: '13.JPG', pathSmall: '13 Small.png'},
//   {key: '14', pathLarge: '14.JPG', pathSmall: '14 Small.png'},
//   {key: '15', pathLarge: '15.JPG', pathSmall: '15 Small.png'},
//   {key: '16', pathLarge: '16.JPG', pathSmall: '16 Small.png'},
//   {key: '17', pathLarge: '17.JPG', pathSmall: '17 Small.png'},
//   {key: '18', pathLarge: '18.JPG', pathSmall: '18 Small.png'},
//   {key: '19', pathLarge: '19.JPG', pathSmall: '19 Small.png'},
//   {key: '20', pathLarge: '20.JPG', pathSmall: '20 Small.png'},
//   {key: '21', pathLarge: '21.JPG', pathSmall: '21 Small.png'},
//   {key: '22', pathLarge: '22.JPG', pathSmall: '22 Small.png'},
//   {key: '23', pathLarge: '23.JPG', pathSmall: '23 Small.png'},
//   {key: '24', pathLarge: '24.JPG', pathSmall: '24 Small.png'},
//   {key: '25', pathLarge: '25.JPG', pathSmall: '25 Small.png'},
//   {key: '26', pathLarge: '26.JPG', pathSmall: '26 Small.png'},
//   {key: '27', pathLarge: '27.JPG', pathSmall: '27 Small.png'},
//   {key: '28', pathLarge: '28.JPG', pathSmall: '28 Small.png'},
//   {key: '29', pathLarge: '29.JPG', pathSmall: '29 Small.png'},
// ];

const images = [
  {key: '1', pathSmall: 'small/DSCF0357-edit-orig.jpeg', pathLarge: 'large/DSCF0357-edit-orig.jpeg', pathOrig: 'orig/DSCF0357-edit-orig.jpeg'},
  {key: '2', pathSmall: 'small/DSCF0379-edit-orig.jpeg', pathLarge: 'large/DSCF0379-edit-orig.jpeg', pathOrig: 'orig/DSCF0379-edit-orig.jpeg'},
  {key: '3', pathSmall: 'small/DSCF0426-edit-orig.jpeg', pathLarge: 'large/DSCF0426-edit-orig.jpeg', pathOrig: 'orig/DSCF0426-edit-orig.jpeg'},
  {key: '4', pathSmall: 'small/DSCF0441-edit-orig.jpeg', pathLarge: 'large/DSCF0441-edit-orig.jpeg', pathOrig: 'orig/DSCF0441-edit-orig.jpeg'},
  {key: '5', pathSmall: 'small/DSCF0446-edit-orig.jpeg', pathLarge: 'large/DSCF0446-edit-orig.jpeg', pathOrig: 'orig/DSCF0446-edit-orig.jpeg'},
  {key: '6', pathSmall: 'small/DSCF0470-edit-orig.jpeg', pathLarge: 'large/DSCF0470-edit-orig.jpeg', pathOrig: 'orig/DSCF0470-edit-orig.jpeg'},
  {key: '7', pathSmall: 'small/DSCF0473-edit-orig.jpeg', pathLarge: 'large/DSCF0473-edit-orig.jpeg', pathOrig: 'orig/DSCF0473-edit-orig.jpeg'},
  {key: '8', pathSmall: 'small/DSCF0492-edit-orig.jpeg', pathLarge: 'large/DSCF0492-edit-orig.jpeg', pathOrig: 'orig/DSCF0492-edit-orig.jpeg'},
  {key: '9', pathSmall: 'small/DSCF0499-edit-orig.jpeg', pathLarge: 'large/DSCF0499-edit-orig.jpeg', pathOrig: 'orig/DSCF0499-edit-orig.jpeg'},
  {key: '10', pathSmall: 'small/DSCF0524-edit-orig.jpeg', pathLarge: 'large/DSCF0524-edit-orig.jpeg', pathOrig: 'orig/DSCF0524-edit-orig.jpeg'},
  {key: '11', pathSmall: 'small/DSCF0533-edit-orig.jpeg', pathLarge: 'large/DSCF0533-edit-orig.jpeg', pathOrig: 'orig/DSCF0533-edit-orig.jpeg'},
  {key: '12', pathSmall: 'small/DSCF0598-edit-orig.jpeg', pathLarge: 'large/DSCF0598-edit-orig.jpeg', pathOrig: 'orig/DSCF0598-edit-orig.jpeg'},
  {key: '13', pathSmall: 'small/DSCF0614-edit-orig.jpeg', pathLarge: 'large/DSCF0614-edit-orig.jpeg', pathOrig: 'orig/DSCF0614-edit-orig.jpeg'},
  {key: '14', pathSmall: 'small/DSCF0626-edit-orig.jpeg', pathLarge: 'large/DSCF0626-edit-orig.jpeg', pathOrig: 'orig/DSCF0626-edit-orig.jpeg'},
  {key: '15', pathSmall: 'small/DSCF0633-edit-orig.jpeg', pathLarge: 'large/DSCF0633-edit-orig.jpeg', pathOrig: 'orig/DSCF0633-edit-orig.jpeg'},
  {key: '16', pathSmall: 'small/DSCF0665-edit-orig.jpeg', pathLarge: 'large/DSCF0665-edit-orig.jpeg', pathOrig: 'orig/DSCF0665-edit-orig.jpeg'},
  {key: '17', pathSmall: 'small/DSCF0674-edit-orig.jpeg', pathLarge: 'large/DSCF0674-edit-orig.jpeg', pathOrig: 'orig/DSCF0674-edit-orig.jpeg'},
  {key: '18', pathSmall: 'small/DSCF0676-edit-orig.jpeg', pathLarge: 'large/DSCF0676-edit-orig.jpeg', pathOrig: 'orig/DSCF0676-edit-orig.jpeg'},
  {key: '19', pathSmall: 'small/DSCF0682-edit-orig.jpeg', pathLarge: 'large/DSCF0682-edit-orig.jpeg', pathOrig: 'orig/DSCF0682-edit-orig.jpeg'},
  {key: '20', pathSmall: 'small/DSCF0715-edit-orig.jpeg', pathLarge: 'large/DSCF0715-edit-orig.jpeg', pathOrig: 'orig/DSCF0715-edit-orig.jpeg'},
  {key: '21', pathSmall: 'small/DSCF0743-edit-orig.jpeg', pathLarge: 'large/DSCF0743-edit-orig.jpeg', pathOrig: 'orig/DSCF0743-edit-orig.jpeg'},
  {key: '22', pathSmall: 'small/DSCF0758-edit-orig.jpeg', pathLarge: 'large/DSCF0758-edit-orig.jpeg', pathOrig: 'orig/DSCF0758-edit-orig.jpeg'},
  {key: '23', pathSmall: 'small/DSCF0769-edit-orig.jpeg', pathLarge: 'large/DSCF0769-edit-orig.jpeg', pathOrig: 'orig/DSCF0769-edit-orig.jpeg'},
  {key: '24', pathSmall: 'small/DSCF0786-edit-orig.jpeg', pathLarge: 'large/DSCF0786-edit-orig.jpeg', pathOrig: 'orig/DSCF0786-edit-orig.jpeg'},
  {key: '25', pathSmall: 'small/DSCF0791-edit-orig.jpeg', pathLarge: 'large/DSCF0791-edit-orig.jpeg', pathOrig: 'orig/DSCF0791-edit-orig.jpeg'},
  {key: '26', pathSmall: 'small/DSCF0793-edit-orig.jpeg', pathLarge: 'large/DSCF0793-edit-orig.jpeg', pathOrig: 'orig/DSCF0793-edit-orig.jpeg'},
  {key: '27', pathSmall: 'small/DSCF0809-edit-orig.jpeg', pathLarge: 'large/DSCF0809-edit-orig.jpeg', pathOrig: 'orig/DSCF0809-edit-orig.jpeg'},
  {key: '28', pathSmall: 'small/DSCF0821-edit-orig.jpeg', pathLarge: 'large/DSCF0821-edit-orig.jpeg', pathOrig: 'orig/DSCF0821-edit-orig.jpeg'},
  {key: '29', pathSmall: 'small/DSCF0822-edit-orig.jpeg', pathLarge: 'large/DSCF0822-edit-orig.jpeg', pathOrig: 'orig/DSCF0822-edit-orig.jpeg'},
  {key: '30', pathSmall: 'small/DSCF0836-edit-orig.jpeg', pathLarge: 'large/DSCF0836-edit-orig.jpeg', pathOrig: 'orig/DSCF0836-edit-orig.jpeg'},
  {key: '31', pathSmall: 'small/DSCF0843-edit-orig.jpeg', pathLarge: 'large/DSCF0843-edit-orig.jpeg', pathOrig: 'orig/DSCF0843-edit-orig.jpeg'},
  {key: '32', pathSmall: 'small/DSCF0848-edit-orig.jpeg', pathLarge: 'large/DSCF0848-edit-orig.jpeg', pathOrig: 'orig/DSCF0848-edit-orig.jpeg'},
  {key: '33', pathSmall: 'small/DSCF0854-edit-orig.jpeg', pathLarge: 'large/DSCF0854-edit-orig.jpeg', pathOrig: 'orig/DSCF0854-edit-orig.jpeg'},
  {key: '34', pathSmall: 'small/DSCF0868-edit-orig.jpeg', pathLarge: 'large/DSCF0868-edit-orig.jpeg', pathOrig: 'orig/DSCF0868-edit-orig.jpeg'},
  {key: '35', pathSmall: 'small/DSCF0879-edit-orig.jpeg', pathLarge: 'large/DSCF0879-edit-orig.jpeg', pathOrig: 'orig/DSCF0879-edit-orig.jpeg'},
  {key: '36', pathSmall: 'small/DSCF0886-edit-orig.jpeg', pathLarge: 'large/DSCF0886-edit-orig.jpeg', pathOrig: 'orig/DSCF0886-edit-orig.jpeg'},
  {key: '37', pathSmall: 'small/DSCF0901-edit-orig.jpeg', pathLarge: 'large/DSCF0901-edit-orig.jpeg', pathOrig: 'orig/DSCF0901-edit-orig.jpeg'},
  {key: '38', pathSmall: 'small/DSCF0905-edit-orig.jpeg', pathLarge: 'large/DSCF0905-edit-orig.jpeg', pathOrig: 'orig/DSCF0905-edit-orig.jpeg'},
  {key: '39', pathSmall: 'small/DSCF0926-edit-orig.jpeg', pathLarge: 'large/DSCF0926-edit-orig.jpeg', pathOrig: 'orig/DSCF0926-edit-orig.jpeg'},
  {key: '40', pathSmall: 'small/DSCF0937-edit-orig.jpeg', pathLarge: 'large/DSCF0937-edit-orig.jpeg', pathOrig: 'orig/DSCF0937-edit-orig.jpeg'},
  {key: '41', pathSmall: 'small/DSCF0938-edit-orig.jpeg', pathLarge: 'large/DSCF0938-edit-orig.jpeg', pathOrig: 'orig/DSCF0938-edit-orig.jpeg'},
  {key: '42', pathSmall: 'small/DSCF0946-edit-orig.jpeg', pathLarge: 'large/DSCF0946-edit-orig.jpeg', pathOrig: 'orig/DSCF0946-edit-orig.jpeg'},
  {key: '43', pathSmall: 'small/DSCF0956-edit-orig.jpeg', pathLarge: 'large/DSCF0956-edit-orig.jpeg', pathOrig: 'orig/DSCF0956-edit-orig.jpeg'},
  {key: '44', pathSmall: 'small/DSCF0961-edit-orig.jpeg', pathLarge: 'large/DSCF0961-edit-orig.jpeg', pathOrig: 'orig/DSCF0961-edit-orig.jpeg'},
  {key: '45', pathSmall: 'small/DSCF0965-edit-orig.jpeg', pathLarge: 'large/DSCF0965-edit-orig.jpeg', pathOrig: 'orig/DSCF0965-edit-orig.jpeg'},
  {key: '46', pathSmall: 'small/IMG_2004-edit-orig.jpeg', pathLarge: 'large/IMG_2004-edit-orig.jpeg', pathOrig: 'orig/IMG_2004-edit-orig.jpeg'},
  {key: '47', pathSmall: 'small/IMG_2010-edit-orig.jpeg', pathLarge: 'large/IMG_2010-edit-orig.jpeg', pathOrig: 'orig/IMG_2010-edit-orig.jpeg'},
  {key: '48', pathSmall: 'small/IMG_2015-edit-orig.jpeg', pathLarge: 'large/IMG_2015-edit-orig.jpeg', pathOrig: 'orig/IMG_2015-edit-orig.jpeg'},
  {key: '49', pathSmall: 'small/IMG_2018-edit-orig.jpeg', pathLarge: 'large/IMG_2018-edit-orig.jpeg', pathOrig: 'orig/IMG_2018-edit-orig.jpeg'},
  {key: '50', pathSmall: 'small/IMG_2023-edit-orig.jpeg', pathLarge: 'large/IMG_2023-edit-orig.jpeg', pathOrig: 'orig/IMG_2023-edit-orig.jpeg'},
  {key: '51', pathSmall: 'small/IMG_2058-edit-orig.jpeg', pathLarge: 'large/IMG_2058-edit-orig.jpeg', pathOrig: 'orig/IMG_2058-edit-orig.jpeg'},
  {key: '52', pathSmall: 'small/IMG_2064-edit-orig.jpeg', pathLarge: 'large/IMG_2064-edit-orig.jpeg', pathOrig: 'orig/IMG_2064-edit-orig.jpeg'},
  {key: '53', pathSmall: 'small/IMG_2069-edit-orig.jpeg', pathLarge: 'large/IMG_2069-edit-orig.jpeg', pathOrig: 'orig/IMG_2069-edit-orig.jpeg'},
  {key: '54', pathSmall: 'small/IMG_2074-edit-orig.jpeg', pathLarge: 'large/IMG_2074-edit-orig.jpeg', pathOrig: 'orig/IMG_2074-edit-orig.jpeg'},
  {key: '55', pathSmall: 'small/IMG_2109-edit-orig.jpeg', pathLarge: 'large/IMG_2109-edit-orig.jpeg', pathOrig: 'orig/IMG_2109-edit-orig.jpeg'},
  {key: '56', pathSmall: 'small/IMG_2165-edit-orig.jpeg', pathLarge: 'large/IMG_2165-edit-orig.jpeg', pathOrig: 'orig/IMG_2165-edit-orig.jpeg'},
  {key: '57', pathSmall: 'small/IMG_5135-edit-orig.jpeg', pathLarge: 'large/IMG_5135-edit-orig.jpeg', pathOrig: 'orig/IMG_5135-edit-orig.jpeg'},
  {key: '58', pathSmall: 'small/IMG_5140-edit-orig.jpeg', pathLarge: 'large/IMG_5140-edit-orig.jpeg', pathOrig: 'orig/IMG_5140-edit-orig.jpeg'},
  {key: '59', pathSmall: 'small/IMG_5157-edit-orig.jpeg', pathLarge: 'large/IMG_5157-edit-orig.jpeg', pathOrig: 'orig/IMG_5157-edit-orig.jpeg'},
  {key: '60', pathSmall: 'small/IMG_5160-edit-orig.jpeg', pathLarge: 'large/IMG_5160-edit-orig.jpeg', pathOrig: 'orig/IMG_5160-edit-orig.jpeg'},
  {key: '61', pathSmall: 'small/IMG_5173-edit-orig.jpeg', pathLarge: 'large/IMG_5173-edit-orig.jpeg', pathOrig: 'orig/IMG_5173-edit-orig.jpeg'},
  {key: '62', pathSmall: 'small/IMG_5210-edit-orig.jpeg', pathLarge: 'large/IMG_5210-edit-orig.jpeg', pathOrig: 'orig/IMG_5210-edit-orig.jpeg'},
  {key: '63', pathSmall: 'small/IMG_5212-edit-orig.jpeg', pathLarge: 'large/IMG_5212-edit-orig.jpeg', pathOrig: 'orig/IMG_5212-edit-orig.jpeg'},
  {key: '64', pathSmall: 'small/IMG_5219-edit-orig.jpeg', pathLarge: 'large/IMG_5219-edit-orig.jpeg', pathOrig: 'orig/IMG_5219-edit-orig.jpeg'},
  {key: '65', pathSmall: 'small/IMG_5223-edit-orig.jpeg', pathLarge: 'large/IMG_5223-edit-orig.jpeg', pathOrig: 'orig/IMG_5223-edit-orig.jpeg' }
];

const imgDirBase = 'images3';

const albEl = document.querySelector('.alb');
const ssEl = document.querySelector('.ss');
const controlsEl = document.querySelector('.ss .ss-controls');
const progressEl = document.querySelector('.ss .ss-progress');
const ssImgEl = document.querySelector('.ss .ss-main-img');
const originalLinkEl = document.querySelector('.original-link');

let size = 'm';
let targetKey = null;
let shown = 'alb'; // one of: alb, ss

const mqlMedium = window.matchMedia('(max-width: 1199px)');
const mqlSmall  = window.matchMedia('(max-width: 749px)');
const onChangeMql = () => {
  const newSize = (() => {
    if (mqlSmall.matches) return 's';
    if (mqlMedium.matches) return 'm';
    return 'l';
  })();
  if (newSize !== size) {
    size = newSize;
    onSizeChange();
  }
};
mqlMedium.addEventListener('change', onChangeMql);
mqlSmall.addEventListener('change', onChangeMql);

const onSizeChange = () => {
  console.log('---- onSizeChange', size);
};

const getRand = (min, max) => {
  const range = max - min;
  return Math.round((Math.random() * range)) + min;
};

const getImgEls = () => {
  return [...document.querySelectorAll('.alb-box img')];
};

const getVisImgEls = () => {
  return [...document.querySelectorAll(`.alb-box.${size} img`)];
};

const getAlbCellEls = () => {
  return [...document.querySelectorAll(`.alb-box:not(.center)`)];
};

const getVisAlbCellEls = () => {
  return [...document.querySelectorAll(`.alb-box:not(.center).${size}`)];
};

const getImg = () => {
  const cellEls = getVisAlbCellEls();
  const imgKeys = cellEls.map((el) => el.getAttribute('data-img-key')).filter(k => k);
  const availImgs = images.filter(img => !imgKeys.includes(img.key));
  const rand = getRand(0, availImgs.length - 1);
  return availImgs[rand];
};

const fade = (el) => {
  el.classList.remove('fade-in');
  setTimeout(() => {
    el.classList.add('fade-in');
  }, 0);  
};

const applyImg = (img, cellEl, animate=false) => {
  const imgEl = cellEl.querySelector('img');
  const aEl = cellEl.querySelector('a');
  imgEl.src = `./${imgDirBase}/${img.pathSmall}`;
  aEl.href = `#${img.key}`;
  cellEl.setAttribute(`data-img-key`, img.key);
  if (animate) fade(imgEl);
};

const startRandomFlipping = () => {
  const flip = () => {
    const cellEls = getVisAlbCellEls();
    const rand = getRand(0, cellEls.length - 1);
    const cellEl = cellEls[rand];
    const img = getImg();
    applyImg(img, cellEl, true);
  };
  setTimeout(() => {
    setInterval(flip, 4000);
    flip();
  }, 1000);
};

const goToImg = (img) => {
  const aEl = document.createElement('a');
  aEl.href = img ? `#${img.key}` : '#';
  document.body.append(aEl);
  aEl.click();
  aEl.remove();
};

const getTargetIndex = () => {
  const targetImg = images.find(img => img.key === targetKey);
  if (!targetImg) return null;
  return images.indexOf(targetImg);
};

const onPressNext = () => {
  const targetIndex = getTargetIndex();
  if (targetIndex == null) return;
  let nextImg = images[targetIndex + 1] || images[0];
  goToImg(nextImg);
};

const onPressPrev = () => {
  const targetIndex = getTargetIndex();
  if (targetIndex == null) return;
  let nextImg = images[targetIndex - 1] || images[images.length - 1];
  goToImg(nextImg);
};

const onPressEscape = () => {
  goToImg(null);
};

const listenForKeys = () => {
  document.addEventListener('keyup', (event) => {
    if (['ArrowRight', 'ArrowDown'].includes(event.code)) onPressNext();
    if (['ArrowLeft', 'ArrowUp'].includes(event.code)) onPressPrev();
    if (event.code === 'Escape') onPressEscape();
  });
};

// let controlsFlashed = false;
const flashControls = () => {
  // if (controlsFlashed) return;
  // controlsFlashed = true;
  controlsEl.classList.add('open');
  setTimeout(() => {
    controlsEl.classList.remove('open');
  }, 3000);
};

const showAlbum = () => {
  document.body.classList.remove('show-ss');
  document.body.classList.add('show-alb');
  shown = 'alb';
};
const showSlideShow = () => {
  document.body.classList.remove('show-alb');
  document.body.classList.add('show-ss');
  if (shown !== 'ss') flashControls();
  shown = 'ss';
};

const onTargetKeyChange = () => {
  console.log('----- onTargetKeyChange', targetKey);
  if (targetKey) {
    showSlideShow();

    // update active progress cell
    const activeCellEL = progressEl.querySelector('.ss-progress-cell.active');
    if (activeCellEL) activeCellEL.classList.remove('active');
    // TODO: don't use nth-child
    const newCellEl = progressEl.querySelector(`.ss-progress-cell:nth-child(${targetKey})`);
    if (newCellEl) newCellEl.classList.add('active');

    // update main img el
    const img = images.find(img => img.key === targetKey);
    if (img) {
      originalLinkEl.href = `${imgDirBase}/${img.pathOrig}`;
      ssImgEl.src = `./${imgDirBase}/${img.pathLarge}`;
      fade(ssImgEl);
    }
  } else {
    showAlbum();
  }
  console.log('----- onTargetKeyChange', targetKey);
};

const listenForTargetChange = () => {
  setInterval(() => {
    const urlKey = window.location.hash.split('#')[1];
    const img = images.find(img => img.key === urlKey);
    const newKey = (img && img.key) || null;
    if (targetKey !== newKey) {
      targetKey = newKey;
      onTargetKeyChange();
    }
  }, 50);
};

const listenForRawClick = () => {
  ssImgEl.addEventListener('click', () => {
    originalLinkEl.click();
  });
};

const renderProgress = () => {
  images.forEach((img) => {
    const el = document.createElement('a');
    el.setAttribute('data-img-key', img.key);
    el.classList.add('ss-progress-cell');
    el.href = `#${img.key}`;
    el.textContent = img.key;
    progressEl.append(el);

    // const el2 = document.createElement('a');
    // el2.setAttribute('data-img-key', img.key);
    // el2.classList.add('ss-progress-cell');
    // el2.href = `#${img.key}`;
    // el2.textContent = img.key;
    // progressEl.append(el2);
  });
};

const onReady = () => {
  onChangeMql();

  const cellEls = getAlbCellEls();
  cellEls.forEach((cellEl) => {
    const img = getImg();
    applyImg(img, cellEl);
  });

  startRandomFlipping();
  listenForKeys();
  listenForTargetChange();
  listenForRawClick();
  renderProgress();
};

onReady();
